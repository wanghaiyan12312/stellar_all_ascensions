namespace = ascensions

country_event = {
	id = ascensions.1
	title = ascensions.1.title
	desc = {
		exclusive_trigger = { num_tradition_categories < @max_tradition_trees }
		text = ascensions.1.title
	}
	desc = {
		exclusive_trigger = { num_tradition_categories >= @max_tradition_trees }
		text = ascensions.1.desc.manytrads
	}

	picture = GFX_evt_genetic_modification
	show_sound = event_alien_nature
	is_triggered_only = yes

	trigger = { has_biogenesis_dlc = yes }

	option = {
		name = EXIT
		default_hide_option = yes
	}

	option = {
		trigger = { 
			NOT = { has_tradition = tr_purity_adopt }
			num_tradition_categories < @max_tradition_trees 
		}
		name = bio.20.a
		set_country_flag = purity_tradition_unlocked
		add_tradition = tr_purity_adopt # Purity Tree
	}

	option = {
		trigger = { 
			NOT = { has_tradition = tr_cloning_adopt } 
			num_tradition_categories < @max_tradition_trees
		}
		name = bio.20.b
		set_country_flag = cloning_tradition_unlocked
		add_tradition = tr_cloning_adopt # Cloning Tree 
	}

	option = {
		trigger = { 
			NOT = { has_tradition = tr_mutation_adopt } 
			num_tradition_categories < @max_tradition_trees
		}
		name = bio.20.c
		set_country_flag = mutation_tradition_unlocked
		add_tradition = tr_mutation_adopt # Mutation Tree
	}
	
}
country_event = {
	id = ascensions.2
	title = ascensions.2.title
	desc =  ascensions.2.desc
	picture = GFX_evt_ancient_databank
	is_triggered_only = yes

	trigger = {
		OR = {
			has_biogenesis_dlc = yes
			has_machine_age_dlc = yes
		}
		is_gestalt = no
	}

	option = {
		name = ascensions.2.no.change
		default_hide_option = yes
	}

	option = {
		name = ascensions.2.default.government
		aap_remove_government_flags = yes
		advanced_authority_refresh = yes
	}

	option = {
		trigger = { has_tradition = tr_cybernetics_finish }
		name = ascensions.2.cyber
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = cyber.1505 }
		}
	}


	option = {
		trigger = { has_tradition = tr_cloning_finish }
		name = ascensions.2.cloning
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = bio.175 }
		}
	}

	option = {
		trigger = { has_tradition = tr_mutation_finish }
		name = ascensions.2.mutation
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = bio.180 }
		}
	}

	option = {
		trigger =  { has_tradition = tr_purity_finish }
		name = ascensions.2.purity
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = bio.170 } 
		}	
	}

	option = {
		trigger =  { 
			has_shroud_dlc = yes
			NOR = {
				has_origin = origin_endbringers
			    has_covenant_with_end_of_the_cycle = yes
			}
			AND = {
				has_country_flag = shroud_songs_rolled
				has_country_flag = shroud_songs_started
			}
		}
		name =  ascensions.2.transcendentpsionic
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = shroud.7120 } 
		}	
	}

	option = {
		trigger =  { 
			has_shroud_dlc = yes
			NOR = {
				has_origin = origin_endbringers
			    has_covenant_with_end_of_the_cycle = yes
			}
			AND = {
				has_country_flag = shroud_songs_rolled
				has_country_flag = shroud_songs_started
			}
		}
		name =  ascensions.2.corporealpsionic
		aap_remove_government_flags = yes
		hidden_effect = {
			country_event = { id = shroud.7121 } 
		}	
	}


}


country_event = {
	id = ascensions.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_owned_leader = {
			leader_event = { id = ascensions.5 }
		}
	}
}

leader_event = {
	id = ascensions.5
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		exists = owner
	}
	immediate = {
		if = {
			limit = {
				# legendary_leader not touch
				NOT = { has_leader_flag = legendary_leader }
			}
			if = {
				limit = {
					Not = {has_trait = leader_trait_erudite}
					leader.species = {
						has_trait = trait_erudite
					}
				}
				add_trait = {
					trait = leader_trait_erudite
					show_message = no
				}
			}
			if = {
				limit = {
					Not = {has_trait = leader_trait_psionic}
					leader.species = {
						has_trait = trait_psionic
					}
				}
				add_trait = {
					trait = leader_trait_psionic
					show_message = no
				}
			}
			if = {
				limit = {
					Not = {has_trait = leader_trait_cyborg}
					leader.species = {
						has_trait = trait_cybernetic
					}
				}
				add_trait = {
					trait = leader_trait_cyborg
					show_message = no
				}
			}			
		}
	}
}

event = {
	id = ascensions.2000
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_playable_country = {
			num_unique_species > 1
			any_owned_species = {
				has_citizenship_type = {
					type = citizenship_assimilation
					country = prev
				}
			}
		}
	}

	immediate = {
		every_playable_country = {
			limit = {
				num_unique_species > 1
				any_owned_species = {
					has_citizenship_type = {
						type = citizenship_assimilation
						country = prev
					}
				}
			}
			# Cyborg Assimilation - Driven Assimilator or Regular Empire
			if = {
				limit = {
					is_hive_empire = no
					num_unique_species > 1
					any_owned_species = {
						has_living_standard = {
							type = living_standard_psi_and_cyborg_assimilation
							country = prev
						}				
					}
				}
				every_owned_planet = {
					limit = {
						NOT = {
							is_planet_class = pc_cosmogenesis_world
						}
					}
					planet_event = {
						id = ascensions.2001
					}
				}
			} 
		}
	}
}


planet_event = {
	id = ascensions.2001
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		any_owned_species = {
			has_living_standard = {
				type = living_standard_psi_and_cyborg_assimilation
				country = prev
			}	
		}
	}

	immediate = {
		set_assimilation_counter_variable = yes		# Sets number of pops to assimilate to 4d25 + Auto-Modded Modifier
		set_update_modifiers_batch = begin			# Freeze modifier calculation for performance

		while = {
			count = assimilation_counter

			# Find a pop group with the right assimilation type
			random_owned_pop_group = {
				limit = {
					NOT = {
						has_pop_group_flag = already_assimilated
					}
					has_living_standard = {
						type = living_standard_psi_and_cyborg_assimilation
						country = root.owner
					}
				}
				# Save the pop group as an event target
				save_event_target_as = old_pop_group
				# Save their species as an event target
				species = {
					save_event_target_as = old_species
				}
				# If a modified species hasn't been created, create one
				# and save them as an event target
				if = {
					limit = {
						NOT = {
							any_galaxy_species = {
								has_species_flag = assimilation_species_mod_of_species@event_target:old_species
								has_species_flag = assimilation_species_mod_of_empire@root.owner
							}
						}
					}
					create_species = {
						is_mod = yes
						name = this
						plural = this
						class = this
						portrait = this
						traits = this
						can_be_modified = this
						homeworld = this
						namelist = this
						traits = {
							trait = trait_cybernetic
							trait = trait_psionic
						}
						gender = this
						effect = {
							modify_species = {
								species = this
								remove_trait = trait_hive_mind
								remove_trait = trait_self_modified
								remove_trait = trait_latent_psionic
								change_scoped_species = no

								effect = {
									set_species_flag = assimilation_species_mod_of_species@event_target:old_species
									set_species_flag = assimilation_species_mod_of_empire@root.owner
									save_event_target_as = target_species
								}
							}
						}
						
					}
				}
				# If a modified species does exist, save them as the event target
				else = {
					random_galaxy_species = {
						limit = {
							has_species_flag = assimilation_species_mod_of_species@event_target:old_species
							has_species_flag = assimilation_species_mod_of_empire@root.owner
						}
						save_event_target_as = target_species
					}
				}
				# Scope back to the planet
				# Create the empty pop group
				# and move pops into it
				planet = {
					create_pop_group = {
						pop_group = event_target:old_pop_group
						species = event_target:target_species
						size = 0
						effect = {
							transfer_pop_amount = {
								source = event_target:old_pop_group
								target = this
								amount = 5
							}
							set_timed_pop_group_flag = {
								flag = already_assimilated
								days = 15
							}
							apply_post_assimilation_effects = yes
						}
					}
				}
			}
		}

		owner = { #Only doing it once since assimilating more than 100 pops a month is hard
			if = {
				limit = { has_ascension_perk = ap_become_the_crisis }
				complete_crisis_objective = crisobj_purge_pops
			}
			assimilate_armies = {
				SOURCE = event_target:old_species
				TARGET = event_target:target_species
			}
			assimilate_colony_ships = {
				SOURCE = event_target:old_species
				TARGET = event_target:target_species
			}
			assimilate_leaders = {
				SOURCE = event_target:old_species
				TARGET = event_target:target_species
			}
		}

		set_update_modifiers_batch = end			# Unfreeze modifier calculation for performance
		clear_assimilation_variables = yes			# Clears variables
	}
}
